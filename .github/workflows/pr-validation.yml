name: PR Validation - Trunk-Based Development

on:
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch:

# Cancel in-progress workflows for the same PR
concurrency:
  group: pr-validation-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: '3.12'
  UV_VERSION: 'latest'

jobs:
  # Job 1: Unit Tests and Coverage
  test-and-coverage:
    name: Unit Tests & Coverage (85% Overall)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && (github.event.pull_request.draft == false || github.event_name == 'workflow_dispatch')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch full history for accurate coverage diff
        
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Install uv
      uses: astral-sh/setup-uv@v3
      with:
        version: ${{ env.UV_VERSION }}
        
    - name: Install dependencies
      run: |
        uv sync --all-extras
        
    - name: Run unit tests with coverage
      run: |
        echo "Running 450+ unit tests with strict coverage requirements..."
        uv run pytest \
          --cov=src \
          --cov-report=xml:coverage.xml \
          --cov-report=html:htmlcov \
          --cov-report=term-missing \
          --cov-fail-under=85 \
          --maxfail=5 \
          -v \
          tests/
      env:
        # API keys from GitHub secrets for tests that need them
        GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_KEY_API }}
        # Test environment configuration
        ENABLE_DOCUMENT_PROCESSING: true
        MODEL_VENDOR: openai
        CHROMA_DB_PATH: ./test_chroma_db
        
    - name: Check Codecov token availability
      run: |
        if [ -z "${{ secrets.CODECOV_TOKEN }}" ]; then
          echo "⚠️ WARNING: CODECOV_TOKEN secret is not set"
          echo "Codecov upload will be skipped"
        else
          echo "✅ CODECOV_TOKEN secret is available"
        fi
        
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v5
      if: ${{ env.CODECOV_TOKEN != '' }}
      env:
        CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        files: ./coverage.xml
        flags: unittests
        name: pr-${{ github.event.pull_request.number }}
        fail_ci_if_error: false
        verbose: true
      continue-on-error: true
        
    - name: Upload coverage reports as artifacts
      uses: actions/upload-artifact@v4
      with:
        name: coverage-reports
        path: |
          coverage.xml
          htmlcov/
        retention-days: 30

  # Job 2: Security Scan
  security-scan:
    name: Security Vulnerability Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && (github.event.pull_request.draft == false || github.event_name == 'workflow_dispatch')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Install uv
      uses: astral-sh/setup-uv@v3
      
    - name: Install dependencies for security scan
      run: uv sync
      
    - name: Run Bandit security scan
      run: |
        uv add --dev bandit[toml]
        uv run bandit -r src/ -f json -o bandit-report.json || true
        uv run bandit -r src/ -f txt
      continue-on-error: true
      
    - name: Run Safety scan for dependencies
      run: |
        uv add --dev safety
        echo "🔍 Scanning dependencies for security vulnerabilities with Safety..."
        uv run safety scan --json --output safety-report.json || true
        uv run safety scan
      continue-on-error: true
      env:
        SAFETY_API_KEY: ${{ secrets.SAFETY_API_KEY }}
      
    - name: Upload security scan results
      uses: actions/upload-artifact@v4
      with:
        name: security-reports
        path: |
          bandit-report.json
          safety-report.json
        retention-days: 30

  # Job 3: Generate Version for Docker Build Test
  generate-version:
    name: Generate Version
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && (github.event.pull_request.draft == false || github.event_name == 'workflow_dispatch')
    needs: [test-and-coverage]
    outputs:
      base_version: ${{ steps.version.outputs.base_version }}
      full_version: ${{ steps.version.outputs.full_version }}
      short_sha: ${{ steps.version.outputs.short_sha }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Generate version number
      id: version
      run: |
        # Extract base version from pyproject.toml
        BASE_VERSION=$(python -c "
        import tomllib
        with open('pyproject.toml', 'rb') as f:
            data = tomllib.load(f)
            print(data['project']['version'])
        ")
        
        # Create version with short SHA
        SHORT_SHA=${GITHUB_SHA:0:7}
        FULL_VERSION="${BASE_VERSION}.${SHORT_SHA}"
        
        echo "base_version=${BASE_VERSION}" >> $GITHUB_OUTPUT
        echo "full_version=${FULL_VERSION}" >> $GITHUB_OUTPUT
        echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
        
        echo "🏷️ Version: ${FULL_VERSION}"

  # Job 4: Docker Build Test using reusable workflow
  docker-build-test:
    name: Docker Build Test with Versioning
    needs: [test-and-coverage, generate-version]
    if: github.event_name == 'pull_request' && (github.event.pull_request.draft == false || github.event_name == 'workflow_dispatch')
    uses: ./.github/workflows/docker-build.yml
    with:
      push_image: false  # Test build only, don't push to registry
      registry: 'ghcr.io'
      image_name: 'rag-file-processor'
      version: ${{ needs.generate-version.outputs.full_version }}
      model_vendor: 'openai'
      environment: 'development'
    secrets:
      GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_KEY_API }}
      REGISTRY_TOKEN: ${{ secrets.REGISTRY_TOKEN }}

  # Job 5: Integration Tests
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && (github.event.pull_request.draft == false || github.event_name == 'workflow_dispatch')
    needs: [test-and-coverage]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Install uv
      uses: astral-sh/setup-uv@v3
      
    - name: Install system dependencies for integration tests
      run: |
        sudo apt-get update
        sudo apt-get install -y tesseract-ocr pandoc
        
    - name: Install dependencies
      run: uv sync --all-extras
      
    - name: Run comprehensive integration tests
      run: |
        echo "Running integration and end-to-end tests..."
        uv run pytest \
          tests/test_rag_integration_comprehensive/ \
          tests/test_app_integration.py \
          tests/test_app_document_processing.py \
          -v \
          --tb=short
      env:
        GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_KEY_API }}
        ENABLE_DOCUMENT_PROCESSING: true
        MODEL_VENDOR: openai

  # Job 6: Summary Report
  pr-summary:
    name: PR Validation Summary
    runs-on: ubuntu-latest
    if: always() && github.event.pull_request.draft == false
    needs: [test-and-coverage, security-scan, generate-version, docker-build-test, integration-tests]
    
    steps:
    - name: Generate PR summary
      run: |
        echo "## 🚀 PR Validation Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Test results
        if [ "${{ needs.test-and-coverage.result }}" = "success" ]; then
          echo "- ✅ **Unit Tests & Coverage**: All 450+ tests passed, 85%+ overall coverage" >> $GITHUB_STEP_SUMMARY
        else
          echo "- ❌ **Unit Tests & Coverage**: Failed - check logs for details" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Security scan
        if [ "${{ needs.security-scan.result }}" = "success" ]; then
          echo "- ✅ **Security Scan**: No critical vulnerabilities found" >> $GITHUB_STEP_SUMMARY
        else
          echo "- ⚠️ **Security Scan**: Issues found - review security reports" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Docker build
        if [ "${{ needs.docker-build-test.result }}" = "success" ]; then
          echo "- ✅ **Docker Build**: Image builds successfully with versioning" >> $GITHUB_STEP_SUMMARY
        else
          echo "- ❌ **Docker Build**: Build failed - check logs" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Integration tests
        if [ "${{ needs.integration-tests.result }}" = "success" ]; then
          echo "- ✅ **Integration Tests**: End-to-end workflows verified" >> $GITHUB_STEP_SUMMARY
        else
          echo "- ❌ **Integration Tests**: Integration failures detected" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### 📋 Trunk-Based Development Checklist" >> $GITHUB_STEP_SUMMARY
        echo "- [x] Short-lived feature branch" >> $GITHUB_STEP_SUMMARY
        echo "- [x] All unit tests passing" >> $GITHUB_STEP_SUMMARY
        echo "- [x] 85% overall code coverage enforced" >> $GITHUB_STEP_SUMMARY
        echo "- [x] Security vulnerability scanning" >> $GITHUB_STEP_SUMMARY
        echo "- [x] Docker image builds with version tagging" >> $GITHUB_STEP_SUMMARY
        echo "- [ ] Manual code review (pending reviewer)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Ready for merge after manual review approval! 🎉**" >> $GITHUB_STEP_SUMMARY